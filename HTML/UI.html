<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DevOps Dashboard – Simple Client</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        margin: 0;
        padding: 20px;
      }

      h1 {
        text-align: center;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
      }

      .card {
        background: #fff;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        margin-top: 0;
      }

      label {
        display: block;
        margin-top: 8px;
        font-size: 0.9rem;
      }

      input {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        box-sizing: border-box;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 0.9rem;
      }

      button {
        margin-top: 12px;
        padding: 8px 14px;
        border: none;
        border-radius: 4px;
        background: #1976d2;
        color: white;
        cursor: pointer;
        font-size: 0.95rem;
      }

      button:hover {
        background: #125aa0;
      }

      .status {
        margin-top: 10px;
        font-size: 0.85rem;
        white-space: pre-wrap;
      }

      .status.success {
        color: #2e7d32;
      }

      .status.error {
        color: #c62828;
      }

      .user-info {
        margin-top: 10px;
        font-size: 0.85rem;
        padding: 8px;
        background: #e3f2fd;
        border-radius: 4px;
      }

      code {
        background: #eee;
        padding: 2px 4px;
        border-radius: 4px;
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body>
    <h1>DevOps Dashboard – Simple Frontend</h1>

    <div class="container">
      <!-- REGISTER (CreateUserDto) -->
      <div class="card">
        <h2>Register</h2>
        <form id="register-form">
          <!-- CreateUserDto: { name, username, password } -->
          <label>
            Name
            <input
              type="text"
              id="register-name"
              required
              minlength="2"
              maxlength="50"
            />
          </label>

          <label>
            Username
            <input
              type="text"
              id="register-username"
              required
              minlength="3"
              maxlength="30"
            />
          </label>

          <label>
            Password
            <input
              type="password"
              id="register-password"
              required
              minlength="8"
              maxlength="128"
            />
          </label>

          <button type="submit">Register</button>
        </form>
        <div id="register-status" class="status"></div>
      </div>

      <!-- LOGIN (LoginUserDto) -->
      <div class="card">
        <h2>Login</h2>
        <form id="login-form">
          <!-- LoginUserDto: { username, password } -->
          <label>
            Username
            <input type="text" id="login-username" required />
          </label>

          <label>
            Password
            <input type="password" id="login-password" required minlength="6" />
          </label>

          <button type="submit">Login</button>
        </form>

        <div id="login-status" class="status"></div>

        <div class="user-info" id="current-user-info">Not logged in.</div>
      </div>

      <!-- CREATE TASK (CreateTaskDto) -->
      <div class="card">
        <h2>Create Task</h2>
        <p style="font-size: 0.85rem">
          Sends <code>{ title, user_id }</code> to<br />
          <code>POST http://4.208.195.210:3002/tasks</code>.<br />
          <code>user_id</code> is taken from the logged-in user.
        </p>
        <form id="task-form">
          <!-- CreateTaskDto: { title, user_id } -->
          <label>
            Title
            <input type="text" id="task-title" required />
          </label>

          <button type="submit">Create Task</button>
        </form>
        <div id="task-status" class="status"></div>
      </div>
    </div>

    <script>
      // === CONFIG – base URLs ===
      const USERS_BASE_URL = "http://4.209.26.155:3001";
      const TASKS_BASE_URL = "http://4.208.195.210:3002";

      // Where we keep the current userId and (optionally) token
      let currentUserId = null;
      let currentToken = null;

      // Try to restore from localStorage
      (function restoreUser() {
        try {
          const storedUserId = localStorage.getItem("userId");
          const storedToken = localStorage.getItem("token");
          if (storedUserId) {
            currentUserId = storedUserId;
          }
          if (storedToken) {
            currentToken = storedToken;
          }
        } catch (e) {
          console.warn("Cannot read localStorage:", e);
        }
        updateCurrentUserInfo();
      })();

      function updateCurrentUserInfo() {
        const el = document.getElementById("current-user-info");
        if (!currentUserId) {
          el.textContent = "Not logged in.";
        } else {
          el.textContent = `Logged in as userId: ${currentUserId}`;
        }
      }

      function setStatus(id, message, isError = false) {
        const el = document.getElementById(id);
        el.textContent = message;
        el.className = "status " + (isError ? "error" : "success");
      }

      // ==================
      // REGISTER  (CreateUserDto)
      // ==================
      document
        .getElementById("register-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const name = document.getElementById("register-name").value;
          const username = document.getElementById("register-username").value;
          const password = document.getElementById("register-password").value;

          // CreateUserDto: { name, username, password }
          const body = {
            name,
            username,
            password,
          };

          try {
            setStatus("register-status", "Registering...", false);

            const res = await fetch(`${USERS_BASE_URL}/users`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(body),
            });

            const data = await res.json();

            if (!res.ok) {
              throw new Error(JSON.stringify(data, null, 2));
            }

            const userId = data.id || data._id || data.userId;
            const msg = userId
              ? `User created successfully. userId = ${userId}`
              : `User created successfully.\nResponse:\n${JSON.stringify(
                  data,
                  null,
                  2
                )}`;

            setStatus("register-status", msg, false);
          } catch (err) {
            setStatus(
              "register-status",
              "Registration failed:\n" + err.message,
              true
            );
          }
        });

      // ==================
      // LOGIN (LoginUserDto)
      // ==================
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const username = document.getElementById("login-username").value;
          const password = document.getElementById("login-password").value;

          // LoginUserDto: { username, password }
          const body = {
            username,
            password,
          };

          try {
            setStatus("login-status", "Logging in...", false);

            const res = await fetch(`${USERS_BASE_URL}/users/login`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(body),
            });

            const data = await res.json();

            if (!res.ok) {
              throw new Error(JSON.stringify(data, null, 2));
            }

            // Try to guess where userId/token are:
            // e.g. { user: { id: ... }, token: "..." } OR { id: ... } etc.
            let userId =
              data.id ||
              data._id ||
              data.userId ||
              (data.user &&
                (data.user.id || data.user._id || data.user.userId));

            let token = data.token || data.accessToken || data.jwt || null;

            if (!userId) {
              // fallback – maybe the whole object IS the user
              userId = data.id || data._id;
            }

            currentUserId = userId || null;
            currentToken = token || null;

            try {
              if (currentUserId) {
                localStorage.setItem("userId", currentUserId);
              }
              if (currentToken) {
                localStorage.setItem("token", currentToken);
              }
            } catch (e) {
              console.warn("Cannot write localStorage:", e);
            }

            updateCurrentUserInfo();

            setStatus(
              "login-status",
              `Login successful.\nuserId = ${
                currentUserId || "UNKNOWN (check backend response)"
              }`,
              false
            );
          } catch (err) {
            setStatus("login-status", "Login failed:\n" + err.message, true);
          }
        });

      // ==================
      // CREATE TASK (CreateTaskDto)
      // ==================
      document
        .getElementById("task-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!currentUserId) {
            setStatus(
              "task-status",
              "You must login first so we have a user_id.",
              true
            );
            return;
          }

          const title = document.getElementById("task-title").value;

          // CreateTaskDto: { title, user_id }
          const body = {
            title,
            user_id: currentUserId, // Mongoose will cast string -> ObjectId
          };

          try {
            setStatus("task-status", "Creating task...", false);

            const headers = {
              "Content-Type": "application/json",
            };

            // If your backend expects Bearer token
            if (currentToken) {
              headers["Authorization"] = `Bearer ${currentToken}`;
            }

            const res = await fetch(`${TASKS_BASE_URL}/tasks`, {
              method: "POST",
              headers,
              body: JSON.stringify(body),
            });

            const data = await res.json();

            if (!res.ok) {
              throw new Error(JSON.stringify(data, null, 2));
            }

            setStatus(
              "task-status",
              "Task created successfully:\n" + JSON.stringify(data, null, 2),
              false
            );

            // Clear input
            document.getElementById("task-title").value = "";
          } catch (err) {
            setStatus(
              "task-status",
              "Task creation failed:\n" + err.message,
              true
            );
          }
        });
    </script>
  </body>
</html>
